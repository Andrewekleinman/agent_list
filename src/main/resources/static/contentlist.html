<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Firestore Contents</title>
    <style>

        .deleteButton:hover{
            background-color: #f44336;
            color:white;
            opacity: 0.8;
        }
        button:hover {
            background-color: #4CAF50;
            color:white;
            opacity: 0.8;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: #4CAF50;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }
        .deleteButton {background-color: #f44336; color:#f44336;} /* Red */

    </style>
</head>
<body>
<header>
    <div class="px-4 py-2 bg-dark text-white">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none">
                    <img align="left" width="70" height="70" src="logo_white.png" alt="logo"><svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"/></svg>
                </a>


                <ul id="icons" class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small">



                    <li>
                        <a href="#" class="nav-link text-white">
                            <img class="bi d-block mx-auto mb-1" src="home.png" width="38" height="24"><use xlink:href="#home"/></img>
                            Home
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link text-white">
                            <img class="bi d-block mx-auto mb-1" src="dashboard.png" width="28" height="24"><use xlink:href="#speedometer2"/></img>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="javascript:logout()" class="nav-link text-white">
                            <img class="bi d-block mx-auto mb-1" src="logout.png" width="24" height="24"></img>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</header>

<h1 th:text="${data}">${data}</h1>
<h1 th:text="${Doc}">${data}</h1>

<div id="callMonitor" >
    <h1 style="text-align:center">Firestore Contents</h1>
    <br>
    <table  class="table table-bordered" border="5" id = dataTable>
        <thead style="background-color:black">
        <tr>
            <th scope="col" style="text-align:center"><span style="color: white; ">ID</span></th>
            <th scope="col" style="text-align:center"><span style="color: white; ">TITLE</span></th>
            <th scope="col" style="text-align:center"><span style="color: white; ">DESCRIPTION</span></th>
            <th scope="col" style="text-align:center"><span style="color: white; ">IMAGE</span></th>
            <th scope="col" style="text-align:center"><span style="color: white; ">VIDEO</span></th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script src="https://unpkg.com/libphonenumber-js@1.9.21/bundle/libphonenumber-max.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-analytics.js";
    import { getFirestore, doc, getDoc, deleteDoc, onSnapshot, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDidtDY_v7Orrs_qgRKsx4hXH2RKqy1LrI",
        authDomain: "esdiacapp-59676.firebaseapp.com",
        databaseURL: "https://esdiacapp-59676-default-rtdb.firebaseio.com",
        projectId: "esdiacapp-59676",
        storageBucket: "esdiacapp-59676.appspot.com",
        messagingSenderId: "912671249160",
        appId: "1:912671249160:web:79bb016c094ee0cef592bd",
        measurementId: "G-5SY5TLJC8Q"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    console.log(analytics)
    const db = getFirestore(app)

    const q = query(collection(db, "test-news"), where("id", "!=", null));
    const unsubscribe = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const id = change.doc.data().id
            if (change.type === "added") {
                var table = document.getElementById("dataTable");
                var html_out = "<td align='center'>" + id + "</td><td align='center'>" + change.doc.data().title+ "</td><td align='center'>" + change.doc.data().description + "</td><td align='center'>" + change.doc.data().image + "</td><td align='center'>" + change.doc.data().video + "</td><td align='center'><button class='button btnUpdate'>Update</button></td><td align='center'><button class='deleteButton btnDelete'>Delete</button></td>";
                var tr = document.createElement("tr");
                tr.innerHTML = html_out;

                table.appendChild(tr);
                console.log(change.doc.data());
            }
            if (change.type === "modified") {
                var table, tr, td, i, j;
                table = document.getElementById("dataTable");
                tr = table.getElementsByTagName("tr");
                for (i = tr.length -1; i >=0; i--) {
                    td = tr[i].getElementsByTagName("td");
                    for (j = 0; j < td.length; j++) {
                        if (td[0].innerHTML === (id))  {
                            console.log("found")
                            td[1].innerHTML=change.doc.data().title
                            td[2].innerHTML=change.doc.data().description
                            td[3].innerHTML=change.doc.data().image
                            td[4].innerHTML=change.doc.data().video
                        }
                    }
                }
            }
            if (change.type === "removed") {
                var table, tr, td, i, j;
                table = document.getElementById("dataTable");
                tr = table.getElementsByTagName("tr");
                for (i = tr.length -1; i >=0; i--) {
                    td = tr[i].getElementsByTagName("td");
                    for (j = 0; j < td.length; j++) {
                        if (td[0].innerHTML === (id))  {
                            console.log(td[0].innerHTML)
                            console.log(i)
                            table.deleteRow(i)

                            break;
                        }
                    }
                }
            }
        });
    });


    $(document).ready(function(){
        $("#dataTable").on('click','.btnDelete',function(){
            const tr = $(this).closest('tr');
            tr.remove();
            makeChange(tr);
        });
    });

    export async function makeChange(tr) {
        var td;
        td = tr[0].getElementsByTagName("td");
        await deleteDoc(doc(db, "test-news", "" + td[0].innerHTML));

    }

    $(document).ready(function(){
        $("#dataTable").on('click','.btnUpdate',function(){
            const tr = $(this).closest('tr');
            update(tr);
        });
    });

    export async function update(tr){
        var td;
        td = tr[0].getElementsByTagName("td");
        window.location='/update-element.html?id='+td[0].innerHTML+'&title='+td[1].innerHTML+'&description='+td[2].innerHTML+'&image='+td[3].innerHTML+'&video='+td[4].innerHTML;
    }
</script>
</body>
</html>
